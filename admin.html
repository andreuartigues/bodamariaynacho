<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Admin — Invitados</title>
</head>
<body>

  <h1>Lista de invitados</h1>

  <button id="download">
    Descargar Excel
  </button>

  <p id="status"></p>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://eurobrvauarexooknbpi.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_AuBKM60iM53tjH4ptBGENQ_7MVuBcum";
    const ADMIN_TOKEN = "SONPARERA";

    const supabaseAdmin = supabase.createClient(
      SUPABASE_URL,
      SUPABASE_ANON_KEY,
      {
        global: {
          headers: {
            "x-admin-token": ADMIN_TOKEN
          }
        }
      }
    );

    const status = document.getElementById("status");

    document.getElementById("download").addEventListener("click", async () => {
      status.innerText = "Descargando invitados...";

      const { data, error } = await supabaseAdmin
        .from("invitados")
        .select("name,email,guests,comment,created_at");

      if (error) {
        status.innerText = "❌ Acceso no autorizado";
        console.error(error);
        return;
      }

      downloadExcel(data);
      status.innerText = "✅ Archivo descargado";
    });

    function downloadExcel(rows) {
      const header = ["Nombre", "Email", "Invitados", "Comentario", "Fecha"];
      const csv = [
        header.join(","),
        ...rows.map(r =>
          [
            r.name,
            r.email,
            r.guests,
            `"${(r.comment || "").replace(/"/g, '""')}"`,
            r.created_at
          ].join(",")
        )
      ].join("\n");

      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "invitados_boda.xlsx";
      a.click();

      URL.revokeObjectURL(url);
    }
  </script>

</body>
</html>
