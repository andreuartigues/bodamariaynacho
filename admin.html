<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Admin — Invitados</title>
</head>
<body>

  <h1>Lista de invitados</h1>

  <button id="download">
    Descargar Excel
  </button>

  <p id="status"></p>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://eurobrvauarexooknbpi.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_AuBKM60iM53tjH4ptBGENQ_7MVuBcum";
    const ADMIN_TOKEN = "SONPARERA";

     // sacar token de la URL
  const urlParams = new URLSearchParams(window.location.search);
  const token = urlParams.get("token");

  if(token !== ADMIN_TOKEN){
    document.body.innerHTML = "<h2>Acceso denegado</h2>";
    throw "Token inválido";
  }

  // Solo si token correcto inicializamos Supabase
  const supabaseAdmin = supabase.createClient(
    SUPABASE_URL,
    SUPABASE_ANON_KEY
  );

  document.getElementById("download").addEventListener("click", async () => {
    const { data, error } = await supabaseAdmin
      .from("rsvp")
      .select("name,email,guests,comment,created_at");

    if (error) {
      alert("Error al descargar: " + error.message);
      return;
    }

    downloadCSV(data);
  });

  function downloadCSV(rows){
    const header = ["Nombre","Email","Invitados","Comentario","Fecha"];
    const csv = [
      header.join(","),
      ...rows.map(r => [
        r.name,
        r.email,
        r.guests,
        `"${(r.comment||"").replace(/"/g,'""')}"`,
        r.created_at
      ].join(","))
    ].join("\n");

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "invitados.csv";
    a.click();
  }
  </script>

</body>
</html>
